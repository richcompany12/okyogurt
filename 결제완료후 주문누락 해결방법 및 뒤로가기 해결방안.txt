요거트 앱 문제점 분석 및 해결 방안
발생한 문제
주문 누락 사건

날짜: 2025-09-12 21:23
결제 ID: payment-175767973748
금액: 11,900원
상황: 포트원에서 결제는 완료되었으나 Firebase에 주문 생성되지 않음
고객 대응: 전화 확인 후 수동으로 주문 처리 및 배달 완료

기술적 증상

웹훅에서 customData: null, metadata: null 확인
"클라이언트 처리 실패" 긴급 SMS 발송됨
포트원 결제는 정상 완료 (MOBILE, 체크카드 결제)

근본 원인 분석
1. 포트원 결제 요청 시 customData 누락
위치: src/components/Order/OrderForm.js
javascript// 현재 paymentConfig에 customData가 없음
const paymentConfig = {
  storeId: process.env.REACT_APP_PORTONE_STORE_ID,
  // ... 기타 설정
  // ❌ customData 누락
};
2. 웹훅의 주문 정보 복원 실패
위치: functions/index.js - paymentwebhook
javascript// 웹훅에서 주문 정보를 찾지 못함
const orderInfo = paymentDetails.customData || paymentDetails.metadata;
if (!orderInfo) {
  // 긴급 SMS 발송
}
3. 간헐적 발생 특성

다른 주문들은 정상 처리됨 (당일 3건 중 1건만 누락)
모바일 브라우저에서 타이밍 이슈로 간헐적 발생 추정

현재 시스템 구조
이중 안전망 설계

클라이언트 처리 (PaymentComplete.js)

결제 완료 후 로컬스토리지에서 주문 정보 복원
Firebase에 직접 주문 생성
3회 재시도 로직 포함


서버 처리 (웹훅)

포트원에서 결제 완료 알림 수신
customData에서 주문 정보 추출
중복 체크 후 주문 생성



문제점

customData 누락으로 웹훅의 백업 기능이 작동하지 않음
클라이언트만 의존할 경우 모바일에서 페이지 전환 시 실행 중단 위험

해결 방안
우선순위 1: customData 추가 (즉시 적용)
파일: OrderForm.js
javascriptcustomData: {
  storeId: storeId,
  items: cart.map(item => ({
    id: item.id,
    name: item.name,
    price: item.price,
    quantity: item.quantity,
    category: item.category || '전체 메뉴'
  })),
  customerPhone: formattedPhone,
  tableNumber: formData.tableNumber.trim() || null,
  specialRequests: formData.specialRequests.trim() || null
}
우선순위 2: 결제 전 임시 주문 생성 (근본 해결책)
수정 파일: 3개

OrderForm.js: 결제 전 임시 주문 생성
functions/index.js: 웹훅에서 임시 주문 상태 업데이트
PaymentComplete.js: 중복 생성 방지 로직

장점:

결제 성공 = 주문 존재 100% 보장
모든 타이밍 이슈 해결
네트워크 지연/브라우저 종료와 무관

기존 뒤로가기 문제 해결
현재 상태

새로운 브랜치 생성: fix/back-navigation-issue
접속 방식별 차별화된 뒤로가기 처리 완료
QR 접속: 두 번 뒤로가기로 앱 종료
일반 접속: 각자의 홈화면으로 이동

향후 개선 계획
단기 (1주 내)

customData 추가로 웹훅 안전망 복구
결제 전 임시 주문 생성 시스템 구축
긴급 SMS 알림 최적화

중기 (1개월 내)

결제 시스템 모니터링 강화
주문 추적 시스템 개선
고객 알림 시스템 다양화 (SMS + 푸시)

장기 (분기별)

결제 시스템 이중화
실시간 주문 상태 추적
자동 복구 시스템 구축

모니터링 지표
핵심 지표

주문 누락률: 현재 약 1.5% (1/67건) → 목표 0%
웹훅 성공률: 측정 필요
긴급 SMS 발송 빈도: 감소 목표

알림 체계

결제 완료되었으나 주문 미생성 시 즉시 SMS
웹훅 실패 시 자동 재시도 후 알림
일일/주간 주문 통계 요약

결론
주문 누락 문제는 포트원 결제 시 customData 누락이 직접적 원인이며, 결제 전 임시 주문 생성으로 근본 해결 가능합니다. 현재의 이중 안전망을 완전히 복구하여 고객 만족도와 매출 손실을 방지할 수 있습니다.